<!DOCTYPE html>
<html>
  <head>
    <title>ChatBot</title>
    <link rel="Stylesheet" href="style.css">
  </head>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>

    <script type="text/babel">
        // Helper function to call Huggingface API for response
        async function getHuggingfaceResponse(prompt) {
          const API_URL = 'https://api-inference.huggingface.co/models/gpt2';

          try {
            const response = await fetch(API_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                inputs: prompt,
                options: { wait_for_model: true }
              }),
            });

            if (!response.ok) {
              throw new Error(`API error: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            if (data.error) {
              throw new Error(`Model error: ${data.error}`);
            }

            if (Array.isArray(data) && data.length > 0) {
              return data[0].generated_text.trim();
            }

            return "Sorry, I couldn't generate a response.";
          } catch (error) {
            console.error('Error fetching Huggingface API:', error);
            return "Sorry, I encountered an error while generating the response.";
          }
        }

        // Override Chatbot.getResponse with async version
        Chatbot.getResponse = (function() {
          return async function(prompt) {
            const response = await getHuggingfaceResponse(prompt);
            return response;
          }
        })();

        function ChatInput({ chatMessages, setChatMessages }){
          const [inputText, setInputText]= React.useState('');

          function saveInputText(event){
            setInputText(event.target.value);
          };

          async function sendMessage(){
            if(!inputText.trim()) return;

            const userMessage = {
              message: inputText,
              sender: "user",
              id: crypto.randomUUID()
            };

            const loadingMessage = {
              message: "...",
              sender: "robot",
              id: crypto.randomUUID(),
              loading: true
            };

            const newChatMessages = [...chatMessages, userMessage, loadingMessage];
            setChatMessages(newChatMessages);
            setInputText('');

            try {
              const response = await Chatbot.getResponse(inputText);

              setChatMessages((prevMessages) => {
                return prevMessages.map(msg => {
                  if (msg.id === loadingMessage.id) {
                    return {
                      message: response,
                      sender: "robot",
                      id: msg.id,
                      loading: false
                    };
                  }
                  return msg;
                });
              });
            } catch (error) {
              setChatMessages((prevMessages) => {
                return prevMessages.map(msg => {
                  if (msg.id === loadingMessage.id) {
                    return {
                      message: "Error: Unable to fetch response.",
                      sender: "robot",
                      id: msg.id,
                      loading: false
                    };
                  }
                  return msg;
                });
              });
            }
          };

          return(
            <div className = "chat-input-container">
              <input 
                placeholder = "Send a message to ChatBot" 
                size = "30"
                onChange={saveInputText}
                value={inputText}
                className = "chat-input"
              />
              <button 
                onClick={sendMessage}
                className = "send-button"
              >
                Send
              </button>
            </div>       
          );
        }

        function ChatMessage({ message ,sender, loading }){
          if(loading){
            return (
              <div className="chat-message-robot">
                <img src="robot.png" className="chat-message-profile" alt="Robot"/>
                <div className="message-text">
                  <span className="loading-dots">
                    <span></span><span></span><span></span><span></span>
                  </span>
                </div>
              </div>
            );
          }

          return (
            <div className={sender === 'user' ? "chat-message-user" : "chat-message-robot"}>
              {sender === 'robot' && (
                <img src="robot.png" className="chat-message-profile" alt="Robot"/>
              )}
              <div className="message-text">
                {message}
              </div>
              {sender === 'user' && (
                <img src="user.png" className="chat-message-profile" alt="User"/>
              )}
            </div>
          );
        }

        function ChatMessages({ chatMessages }){
          React.useEffect(() => {
            const chatMessagesContainer = document.querySelector('.chat-messages-container');
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
          }, [chatMessages]);

          return (
            <div className="chat-messages-container">
              {chatMessages.map(({message, sender, id, loading}) => (
                <ChatMessage
                  message={message}
                  sender={sender}
                  key={id}
                  loading={loading}
                />
              ))}
            </div>
          );    
        }
        
        function App(){
          const [chatMessages, setChatMessages] = React.useState([
            {
              message : "hello chatbot",
              sender : "user",
              id : "id1"
            },{
              message : "Hello! How can I help you?",
              sender : "robot",
              id : "id2"
            },{
              message : "can you get me todays date?",
              sender : "user",
              id : "id3"
            },{
              message : "Today is November 8",
              sender : "robot",
              id : "id4"
            }
          ]);

          return(
            <div className = "app-container">
              <ChatMessages
                chatMessages={chatMessages}
              />
              <ChatInput
                chatMessages={chatMessages}
                setChatMessages={setChatMessages}
              />
            </div> 
          );
        }

      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>
